'use strict';

var Vow = require('vow'),
    ym = require('ym'),
    path = require('path');

/**
 * Контейнер сервисов
 * @param {Object} params
 * @constructor
 */
function ServiceContainer(params) {
    this._modules = ym.create();

    // декларируем глобальный модуль с переданными настройками
    this._modules.define('GLOBAL', function(provide) {
        provide(params);
    });
}

/**
 * Кеш сервисов
 * @type {Object}
 * @private
 */
ServiceContainer._services = {};

/**
 * Задекларировать сервис в контейнере
 * @param {String} name имя сервиса
 * @param {Array} deps массив зависимостей
 * @param {*} service сервис
 */
ServiceContainer.decl = function(name, deps, service) {
    if (arguments.length === 2) {
        service = deps;
        deps = [];
    }

    ServiceContainer._services[name] = {
        name: name,
        deps: deps,
        service: service
    };
};

/**
 * Предоставить сервисы. Если сервис на выходе предоставляет промис, то будет возвращен результат промиса
 * @param {Array} services
 * @param {Function} callback
 * @param {*} callbackCtx
 * @returns {*}
 */
ServiceContainer.prototype.require = function(services, callback, callbackCtx) {
    services.forEach(this._define, this);

    this._modules.require(services, function() {
        callback.apply(callbackCtx, arguments);
    });
};

/**
 * Возвращает промис с инстансом сервиса
 * @param service
 * @returns {Vow.promise}
 */
ServiceContainer.prototype.getService = function(service) {
    var promise = new Vow.promise();

    this.require([service], function(res) {
        promise.fulfill(res);
    });

    return promise;
};

/**
 * Инициализировать сервис
 * @param {String} name
 * @private
 */
ServiceContainer.prototype._define = function(name) {
    if (this._modules.isDefined(name)) return;

    require(path.join(__dirname, '../services', name));

    var decl = ServiceContainer._services[name];

    // инициализация зависимых сервисов
    decl.deps.forEach(this._define, this);

    this._modules.define(name, decl.deps, function(provide) {
        var args = Array.prototype.slice.call(arguments, 1),
            serviceDefine = decl.service;

        Vow.when(serviceDefine.apply(null, args), function(res) {
            provide(res);
        }).done();
    });
};

module.exports = ServiceContainer;
